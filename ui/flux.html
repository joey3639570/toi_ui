<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FLUX NSFW Image Generator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .input-group {
            margin-bottom: 20px;
        }
        textarea {
            width: 100%;
            height: 100px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            margin-bottom: 10px;
        }
        .parameters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .parameter-group {
            margin-bottom: 10px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="number"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .result {
            margin-top: 20px;
            text-align: center;
        }
        .result img {
            max-width: 100%;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        .error {
            color: red;
            margin-top: 10px;
            display: none;
            padding: 10px;
            background-color: #fff3f3;
            border-radius: 4px;
        }
        .seed-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .seed-control button {
            width: auto;
            padding: 8px 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>FLUX NSFW Image Generator</h1>
        <div class="input-group">
            <label for="prompt">Positive Prompt:</label>
            <textarea id="prompt" placeholder="Enter your prompt..."></textarea>
        </div>
        <div class="input-group">
            <label for="negative_prompt">Negative Prompt:</label>
            <textarea id="negative_prompt" placeholder="Enter negative prompt..."></textarea>
        </div>
        <div class="parameters">
            <div class="parameter-group">
                <label for="steps">Steps (1-50):</label>
                <input type="number" id="steps" value="28" min="1" max="50">
            </div>
            <div class="parameter-group">
                <label for="guidance_scale">Guidance Scale:</label>
                <input type="number" id="guidance_scale" value="7.0" step="0.1" min="0" max="20">
            </div>
            <div class="parameter-group">
                <label for="width">Width (256-1536):</label>
                <input type="number" id="width" value="1024" min="256" max="1536" step="64">
            </div>
            <div class="parameter-group">
                <label for="height">Height (256-1536):</label>
                <input type="number" id="height" value="1024" min="256" max="1536" step="64">
            </div>
            <div class="parameter-group">
                <label for="seed">Seed:</label>
                <div class="seed-control">
                    <input type="number" id="seed" value="42">
                    <button id="randomSeed">Random</button>
                </div>
            </div>
        </div>
        <button id="generateBtn">Generate Image</button>
        <div class="loading" id="loading">
            Generating image... Please wait...
        </div>
        <div class="error" id="error"></div>
        <div class="result" id="result"></div>
    </div>

    <script>
        const API_URL = 'http://localhost:5000/txt2img';
        const MAX_RETRIES = 3;
        const RETRY_DELAY = 1000;

        const generateBtn = document.getElementById('generateBtn');
        const promptInput = document.getElementById('prompt');
        const negativePromptInput = document.getElementById('negative_prompt');
        const stepsInput = document.getElementById('steps');
        const guidanceScaleInput = document.getElementById('guidance_scale');
        const widthInput = document.getElementById('width');
        const heightInput = document.getElementById('height');
        const seedInput = document.getElementById('seed');
        const randomSeedBtn = document.getElementById('randomSeed');
        const loadingDiv = document.getElementById('loading');
        const errorDiv = document.getElementById('error');
        const resultDiv = document.getElementById('result');

        // Set default negative prompt
        negativePromptInput.value = "text, watermark, signature, cartoon, anime, illustration, painting, drawing, low quality, blurry";

        async function wait(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        async function checkServerHealth() {
            try {
                const response = await fetch('http://localhost:5000/health');
                return response.ok;
            } catch (error) {
                console.error('Server health check failed:', error);
                return false;
            }
        }

        async function tryRequest(retryCount = 0) {
            try {
                console.log('Sending request to proxy server...');
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        prompt: promptInput.value.trim(),
                        negative_prompt: negativePromptInput.value.trim(),
                        num_inference_steps: parseInt(stepsInput.value),
                        guidance_scale: parseFloat(guidanceScaleInput.value),
                        width: parseInt(widthInput.value),
                        height: parseInt(heightInput.value),
                        seed: parseInt(seedInput.value)
                    })
                });

                console.log('Response status:', response.status);
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Server error response:', errorText);
                    throw new Error(`Server error: ${response.status} ${errorText}`);
                }

                const blob = await response.blob();
                console.log('Received image blob:', blob.size, 'bytes');
                const imageUrl = URL.createObjectURL(blob);
                displayImage(imageUrl);
                return true;
            } catch (error) {
                console.error(`Attempt ${retryCount + 1} failed:`, error);
                if (retryCount < MAX_RETRIES - 1) {
                    console.log(`Retrying in ${RETRY_DELAY}ms...`);
                    await wait(RETRY_DELAY);
                    return tryRequest(retryCount + 1);
                }
                throw error;
            }
        }

        generateBtn.addEventListener('click', async () => {
            const prompt = promptInput.value.trim();
            if (!prompt) {
                showError('Please enter a prompt');
                return;
            }

            try {
                setLoading(true);
                
                const isServerHealthy = await checkServerHealth();
                if (!isServerHealthy) {
                    throw new Error('Cannot connect to the proxy server. Please make sure it is running on port 5000.');
                }

                await tryRequest();
            } catch (error) {
                console.error('Error:', error);
                let errorMessage = error.message;
                if (error.message.includes('Failed to fetch')) {
                    errorMessage = 'Cannot connect to the server. Please make sure the server is running on port 5000.';
                }
                showError(errorMessage);
            } finally {
                setLoading(false);
            }
        });

        randomSeedBtn.addEventListener('click', () => {
            seedInput.value = Math.floor(Math.random() * 2147483647);
        });

        function setLoading(isLoading) {
            generateBtn.disabled = isLoading;
            loadingDiv.style.display = isLoading ? 'block' : 'none';
            errorDiv.style.display = 'none';
        }

        function showError(message) {
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function displayImage(imageUrl) {
            resultDiv.innerHTML = `<img src="${imageUrl}" alt="Generated image">`;
        }
    </script>
</body>
</html> 